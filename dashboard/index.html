<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Intel ‚Äî Review Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --bg: #0c0f14;
      --surface: #141820;
      --surface2: #1c2230;
      --border: #252d3d;
      --border-light: #2d3650;
      --accent: #c8a96e;
      --accent-dim: rgba(200, 169, 110, 0.15);
      --accent-glow: rgba(200, 169, 110, 0.08);
      --google-green: #4ade80;
      --ta-green: #34d399;
      --text: #e8eaf0;
      --text-dim: #8891a8;
      --text-muted: #4f5a72;
      --star: #f59e0b;
      --red: #f87171;
      --blue: #60a5fa;
      --radius: 12px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
    }

    /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .logo-text {
      font-family: 'DM Serif Display', serif;
      font-size: 18px;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .last-fetch {
      font-size: 12px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .badge-google { background: rgba(74, 222, 128, 0.1); color: var(--google-green); border: 1px solid rgba(74, 222, 128, 0.2); }
    .badge-ta { background: rgba(52, 211, 153, 0.1); color: var(--ta-green); border: 1px solid rgba(52, 211, 153, 0.2); }
    .header-refresh-btn { padding: 4px 10px; background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); border-radius: 20px; font-family: inherit; font-size: 11px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; transition: border-color 0.15s, color 0.15s; }
    .header-refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .header-refresh-btn:disabled { opacity: 0.5; cursor: default; }

    /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
    .layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: calc(100vh - 64px);
    }

    /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px 0;
    }

    .sidebar-section {
      padding: 8px 16px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .filter-group {
      padding: 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .search-box {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-box:focus {
      border-color: var(--accent);
    }

    .sort-select {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 12px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238891a8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    /* Property List */
    .property-list {
      padding: 8px;
    }

    .property-item {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.15s;
      border: 1px solid transparent;
    }

    .property-item:hover {
      background: var(--surface2);
    }

    .property-item.active {
      background: var(--accent-dim);
      border-color: rgba(200, 169, 110, 0.25);
    }

    .property-item-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .property-item.active .property-item-name {
      color: var(--accent);
    }

    .property-item-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .property-item-city {
      font-size: 11px;
      color: var(--text-muted);
    }

    .mini-rating {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 11px;
    }

    .mini-rating .star { color: var(--star); font-size: 9px; }
    .mini-rating .val { color: var(--text-dim); font-weight: 600; }

    .mini-rating.google .val { color: var(--google-green); }
    .mini-rating.ta .val { color: var(--ta-green); }

    /* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
    .main {
      overflow-y: auto;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ‚îÄ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ‚îÄ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .stat-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .stat-value {
      font-family: 'DM Serif Display', serif;
      font-size: 28px;
      color: var(--text);
      line-height: 1;
    }

    .stat-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ‚îÄ‚îÄ‚îÄ PROPERTY DETAIL ‚îÄ‚îÄ‚îÄ */
    .property-header {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px 28px;
    }

    .property-title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .property-title {
      font-family: 'DM Serif Display', serif;
      font-size: 26px;
      color: var(--text);
      line-height: 1.2;
      margin-bottom: 4px;
    }

    .property-location {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .brand-tag {
      display: inline-block;
      padding: 3px 10px;
      background: var(--surface2);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      letter-spacing: 0.04em;
    }

    .ratings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    .rating-block {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
    }

    .rating-source {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .rating-source.google { color: var(--google-green); }
    .rating-source.ta { color: var(--ta-green); }

    .rating-main {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .rating-number {
      font-family: 'DM Serif Display', serif;
      font-size: 36px;
      line-height: 1;
    }

    .rating-number.google { color: var(--google-green); }
    .rating-number.ta { color: var(--ta-green); }

    .rating-max { font-size: 14px; color: var(--text-muted); }

    .stars-row {
      display: flex;
      gap: 2px;
      margin: 6px 0;
    }

    .star-icon { color: var(--star); font-size: 13px; }
    .star-icon.empty { color: var(--text-muted); opacity: 0.4; }

    .rating-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .subratings {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .subrating-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .subrating-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .subrating-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
    }

    .ranking-badge {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-dim);
      font-style: italic;
    }

    /* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
    .tabs {
      display: flex;
      gap: 2px;
      background: var(--surface);
      padding: 4px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .tab {
      flex: 1;
      padding: 8px 16px;
      text-align: center;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .tab.active {
      background: var(--accent-dim);
      border-color: rgba(200, 169, 110, 0.25);
      color: var(--accent);
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ‚îÄ‚îÄ‚îÄ REVIEWS ‚îÄ‚îÄ‚îÄ */
    .reviews-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .source-toggle {
      display: flex;
      gap: 8px;
    }

    .source-btn {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border-light);
      background: transparent;
      color: var(--text-muted);
      transition: all 0.15s;
    }

    .source-btn.active.google { 
      background: rgba(74, 222, 128, 0.1); 
      border-color: rgba(74, 222, 128, 0.3); 
      color: var(--google-green); 
    }

    .source-btn.active.ta { 
      background: rgba(52, 211, 153, 0.1); 
      border-color: rgba(52, 211, 153, 0.3); 
      color: var(--ta-green); 
    }

    .reviews-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .review-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: border-color 0.2s;
    }

    .review-card:hover {
      border-color: var(--border-light);
    }

    .review-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .reviewer-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .reviewer-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface2);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .reviewer-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .reviewer-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }

    .reviewer-location {
      font-size: 11px;
      color: var(--text-muted);
    }

    .review-rating-stars { display: flex; gap: 2px; }
    .review-star { color: var(--star); font-size: 12px; }
    .review-star.empty { color: var(--border-light); }

    .review-meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .review-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .review-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .review-trip-type {
      font-size: 10px;
      padding: 2px 8px;
      background: var(--surface2);
      border-radius: 10px;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .review-text {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-dim);
    }

    .read-more {
      color: var(--accent);
      cursor: pointer;
      font-size: 12px;
      margin-left: 4px;
    }

    .no-data {
      text-align: center;
      padding: 48px;
      color: var(--text-muted);
    }

    .no-data-icon { font-size: 32px; margin-bottom: 12px; }
    .no-data-text { font-size: 14px; }
    .no-data-hint { font-size: 12px; margin-top: 6px; color: var(--text-muted); opacity: 0.7; }

    /* ‚îÄ‚îÄ‚îÄ PHOTOS ‚îÄ‚îÄ‚îÄ */
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .photo-card {
      aspect-ratio: 4/3;
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--surface2);
      position: relative;
      cursor: pointer;
    }

    .photo-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .photo-card:hover img {
      transform: scale(1.05);
    }

    .photo-source-tag {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 2px 7px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .photo-source-tag.google { background: rgba(74, 222, 128, 0.85); color: #0a1a0f; }
    .photo-source-tag.ta { background: rgba(52, 211, 153, 0.85); color: #0a1a0f; }

    .photo-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      padding: 20px 10px 8px;
      font-size: 11px;
      color: rgba(255,255,255,0.8);
    }

    /* ‚îÄ‚îÄ‚îÄ LIGHTBOX ‚îÄ‚îÄ‚îÄ */
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .lightbox.open { display: flex; }

    .lightbox-img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: var(--radius);
      object-fit: contain;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
    .lightbox-nav.prev { left: 20px; }
    .lightbox-nav.next { right: 20px; }

    /* ‚îÄ‚îÄ‚îÄ PORTFOLIO VIEW ‚îÄ‚îÄ‚îÄ */
    .portfolio-table {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .portfolio-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .portfolio-table th {
      background: var(--surface2);
      padding: 10px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .portfolio-table th:hover { color: var(--text-dim); }

    .portfolio-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: middle;
    }

    .portfolio-table tr:last-child td { border-bottom: none; }

    .portfolio-table tr:hover td { background: var(--surface2); }

    .portfolio-table tr { cursor: pointer; }

    .table-name { font-weight: 500; color: var(--text); }
    .table-city { color: var(--text-muted); font-size: 12px; }
    .table-brand { color: var(--text-muted); font-size: 12px; }

    .rating-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .rating-pill.google { background: rgba(74, 222, 128, 0.1); color: var(--google-green); }
    .rating-pill.ta { background: rgba(52, 211, 153, 0.1); color: var(--ta-green); }
    .rating-pill.none { background: var(--surface2); color: var(--text-muted); }

    /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      gap: 16px;
      color: var(--text-muted);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      color: var(--text-muted);
      text-align: center;
      padding: 48px;
    }

    .welcome-icon { font-size: 48px; margin-bottom: 8px; }
    .welcome-title { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--text-dim); }
    .welcome-text { font-size: 14px; line-height: 1.6; max-width: 380px; }

    /* ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ */
    #view-overview { display: none; }
    #view-portfolio { display: none; }

    /* ‚îÄ‚îÄ‚îÄ SAVED FOLDERS ‚îÄ‚îÄ‚îÄ */
    .folders-section { margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px; }
    .folders-section-header { display: flex; align-items: center; justify-content: space-between; padding: 6px 16px; }
    .folders-section-label { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); }
    .folder-add-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px; line-height: 1; padding: 2px 4px; border-radius: 4px; transition: color 0.15s; }
    .folder-add-btn:hover { color: var(--accent); }
    .new-folder-input-row { display: none; padding: 6px 16px; gap: 6px; align-items: center; }
    .new-folder-input-row.visible { display: flex; }
    .new-folder-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; outline: none; }
    .new-folder-input:focus { border-color: var(--accent); }
    .new-folder-confirm { background: var(--accent-dim); border: 1px solid rgba(200,169,110,0.3); color: var(--accent); padding: 6px 10px; border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; cursor: pointer; }
    .folder-group { margin-bottom: 4px; }
    .folder-header { display: flex; align-items: center; justify-content: space-between; padding: 7px 16px; cursor: pointer; border-radius: var(--radius-sm); margin: 0 8px; transition: background 0.15s; }
    .folder-header:hover { background: var(--surface2); }
    .folder-header-left { display: flex; align-items: center; gap: 6px; min-width: 0; }
    .folder-chevron { font-size: 9px; color: var(--text-muted); transition: transform 0.2s; flex-shrink: 0; }
    .folder-chevron.open { transform: rotate(90deg); }
    .folder-name { font-size: 12px; font-weight: 600; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .folder-count { font-size: 10px; color: var(--text-muted); flex-shrink: 0; }
    .folder-delete-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; padding: 2px 4px; border-radius: 4px; opacity: 0; transition: opacity 0.15s, color 0.15s; }
    .folder-header:hover .folder-delete-btn { opacity: 1; }
    .folder-delete-btn:hover { color: var(--red); }
    .folder-hotel-list { display: none; padding: 0 8px 4px 8px; }
    .folder-hotel-list.open { display: block; }
    .folder-hotel-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid transparent; transition: background 0.15s; gap: 6px; }
    .folder-hotel-item:hover { background: var(--surface2); }
    .folder-hotel-item.active { background: var(--accent-dim); border-color: rgba(200,169,110,0.25); }
    .folder-hotel-info { min-width: 0; flex: 1; }
    .folder-hotel-name { font-size: 12px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .folder-hotel-item.active .folder-hotel-name { color: var(--accent); }
    .folder-hotel-city { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .folder-hotel-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; line-height: 1; padding: 2px 4px; border-radius: 4px; opacity: 0; flex-shrink: 0; transition: opacity 0.15s, color 0.15s; }
    .folder-hotel-item:hover .folder-hotel-remove { opacity: 1; }
    .folder-hotel-remove:hover { color: var(--red); }

    /* ‚îÄ‚îÄ‚îÄ SAVE DROPDOWN ‚îÄ‚îÄ‚îÄ */
    .save-dropdown-wrap { position: relative; display: inline-block; }
    .save-btn { padding: 7px 14px; background: var(--accent-dim); border: 1px solid rgba(200,169,110,0.3); color: var(--accent); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; }
    .save-btn:hover { background: rgba(200,169,110,0.22); }
    .save-dropdown { display: none; position: absolute; top: calc(100% + 6px); right: 0; background: var(--surface); border: 1px solid var(--border-light); border-radius: var(--radius-sm); min-width: 190px; z-index: 200; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; }
    .save-dropdown.open { display: block; }
    .save-dropdown-item { padding: 10px 14px; font-size: 12px; color: var(--text-dim); cursor: pointer; transition: background 0.12s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .save-dropdown-item:hover { background: var(--surface2); }
    .save-dropdown-item.new-folder { color: var(--accent); border-top: 1px solid var(--border); }
    .save-dropdown-item.already-saved { color: var(--text-muted); cursor: default; font-style: italic; }
    .save-dropdown-item.already-saved:hover { background: none; }

    /* ‚îÄ‚îÄ‚îÄ SAVED HOTEL DETAIL ‚îÄ‚îÄ‚îÄ */
    .cached-badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; background: var(--accent-dim); border: 1px solid rgba(200,169,110,0.25); border-radius: 20px; font-size: 11px; color: var(--accent); font-weight: 600; }
    .refresh-btn { padding: 7px 12px; background: var(--surface2); border: 1px solid var(--border-light); color: var(--text-dim); border-radius: var(--radius-sm); font-family: inherit; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: border-color 0.15s, color 0.15s; }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
    .refresh-btn.spinning { opacity: 0.6; pointer-events: none; }

    /* ‚îÄ‚îÄ‚îÄ FOLDER OVERVIEW ‚îÄ‚îÄ‚îÄ */
    .folder-overview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .top-bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .ranking-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .ranking-card-title { font-size: 11px; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
    .ranking-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); cursor: pointer; transition: color 0.12s; }
    .ranking-row:last-child { border-bottom: none; }
    .ranking-row:hover { color: var(--accent); }
    .ranking-pos { font-size: 16px; font-weight: 700; font-family: 'DM Serif Display', serif; color: var(--text-muted); width: 24px; flex-shrink: 0; }
    .ranking-name { flex: 1; font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ranking-score { font-size: 14px; font-weight: 700; flex-shrink: 0; }
    /* ‚îÄ‚îÄ‚îÄ FOLDER MAP ‚îÄ‚îÄ‚îÄ */
    #folder-map { height: 380px; border-radius: var(--radius-sm); overflow: hidden; }
    /* Fullscreen map modal */
    #map-fullscreen-modal { display: none; position: fixed; inset: 0; z-index: 9999; background: var(--bg); flex-direction: column; }
    #map-fullscreen-modal.open { display: flex; }
    #map-fullscreen-map { flex: 1; }
    .folder-map-marker { background: var(--accent); border: 2px solid rgba(255,255,255,0.9); border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .leaflet-popup-content-wrapper { background: var(--surface) !important; border: 1px solid var(--border-light) !important; border-radius: var(--radius) !important; color: var(--text) !important; font-family: 'DM Sans', sans-serif !important; box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important; }
    .leaflet-popup-tip { background: var(--surface) !important; }
    .leaflet-popup-close-button { color: var(--text-muted) !important; }
    .leaflet-control-zoom a { background: var(--surface) !important; border-color: var(--border) !important; color: var(--text-dim) !important; }
    .folder-header-left { display: flex; align-items: center; gap: 6px; min-width: 0; flex: 1; cursor: pointer; }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">üè®</div>
    <div>
      <div class="logo-text">Portfolio Intel</div>
      <div class="logo-sub">Review Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <span class="last-fetch" id="last-fetch">Loading...</span>
    <button class="header-refresh-btn" id="header-refresh-btn" onclick="refreshAllData()">‚Üª Refresh Data</button>
    <span class="badge badge-google" id="google-badge">Google</span>
    <span class="badge badge-ta" id="ta-badge">TripAdvisor</span>
  </div>
</header>

<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="filter-group">
      <input class="search-box" id="search" type="text" placeholder="Search any hotel...">
    </div>

    <div class="filter-group" id="sort-group">
      <select class="sort-select" id="sort-select">
        <option value="id">Sort: Property #</option>
        <option value="name">Sort: Name A‚ÄìZ</option>
        <option value="city">Sort: City</option>
        <option value="google-rating">Sort: Google Rating ‚Üì</option>
        <option value="ta-rating">Sort: TA Rating ‚Üì</option>
        <option value="google-reviews">Sort: Google Reviews ‚Üì</option>
      </select>
    </div>

    <div class="sidebar-section" id="list-label" style="margin-top:8px;">Properties</div>
    <div class="property-list" id="property-list">
      <div class="loading"><div class="spinner"></div></div>
    </div>

    <!-- Named Folders -->
    <div class="folders-section" id="folders-section">
      <div class="folders-section-header">
        <span class="folders-section-label">Saved Folders</span>
        <button class="folder-add-btn" onclick="showNewFolderInput()" title="New folder">Ôºã</button>
      </div>
      <div class="new-folder-input-row" id="new-folder-row">
        <input class="new-folder-input" id="new-folder-name" placeholder="Folder name‚Ä¶" maxlength="40">
        <button class="new-folder-confirm" onclick="createFolder()">Add</button>
      </div>
      <div id="folders-list"></div>
    </div>
  </div>

  <!-- Main -->
  <div class="main" id="main">

    <!-- Folder Overview -->
    <div id="view-folder-overview" style="display:none;">
      <div id="folder-overview-content"></div>
    </div>

    <!-- Portfolio Overview Table -->
    <div id="view-portfolio">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <h2 style="font-family:'DM Serif Display',serif;font-size:22px;">Portfolio Overview</h2>
        <button onclick="exportCSV()" style="padding:7px 16px;background:var(--surface2);border:1px solid var(--border-light);color:var(--text-dim);border-radius:var(--radius-sm);font-family:inherit;font-size:12px;cursor:pointer;">Export CSV</button>
      </div>
      <div class="portfolio-table" id="portfolio-table-wrap"></div>
    </div>

    <!-- Property Overview -->
    <div id="view-overview">
      <div id="overview-content"></div>
    </div>

    <!-- Welcome State -->
    <div id="view-welcome" class="welcome">
      <div class="welcome-icon">üè®</div>
      <div class="welcome-title">Select a Property</div>
      <div class="welcome-text">
        Choose a property from the sidebar, search for any hotel, or click a
        <strong>saved folder</strong> to see its portfolio overview with top &amp; bottom rankings and a map.
      </div>
      <div style="margin-top:16px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);max-width:400px;text-align:left;">
        <div style="font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;">No data yet?</div>
        <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
          1. Copy <code style="background:var(--surface2);padding:1px 5px;border-radius:4px;">.env.example</code> to <code style="background:var(--surface2);padding:1px 5px;border-radius:4px;">.env</code><br>
          2. Add your API keys to <code style="background:var(--surface2);padding:1px 5px;border-radius:4px;">.env</code><br>
          3. Run <code style="background:var(--surface2);padding:1px 5px;border-radius:4px;">npm run fetch</code> in terminal<br>
          4. Come back here and refresh
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <button class="lightbox-close" onclick="closeLightbox()">‚úï</button>
  <button class="lightbox-nav prev" onclick="lightboxNav(-1)">‚Äπ</button>
  <img class="lightbox-img" id="lightbox-img" src="" alt="">
  <button class="lightbox-nav next" onclick="lightboxNav(1)">‚Ä∫</button>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  State
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let portfolio = [];
let selectedId = null;
let activeReviewSource = 'google';
let lightboxPhotos = [];
let lightboxIdx = 0;
let folders = [];
let activeFolderStates = {};
let selectedFolderHotel = null;
let selectedFolder = null;
let currentFolderMap = null;
let folderMapHotels = [];
let currentFullscreenMap = null;
let currentSearchHotel = null;
let activeSearchReviewSource = 'all';
let _reviewCtx = null;
const _reviewCache = new Map();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Init
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  try {
    const [meta, data, status] = await Promise.all([
      fetch('/api/metadata').then(r => r.json()).catch(() => ({})),
      fetch('/api/portfolio').then(r => r.json()).catch(() => []),
      fetch('/api/status').then(r => r.json()).catch(() => ({})),
    ]);

    // Update header
    if (meta.lastFetch) {
      const d = new Date(meta.lastFetch);
      document.getElementById('last-fetch').textContent =
        'Last fetch: ' + d.toLocaleDateString('en-US', { month:'short', day:'numeric' }) +
        ' ' + d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
    } else {
      document.getElementById('last-fetch').textContent = 'No data fetched yet';
    }

    if (meta.googleSuccess !== undefined) {
      document.getElementById('google-badge').textContent =
        `Google ${meta.googleSuccess}/${meta.propertyCount}`;
    }
    if (meta.taSuccess !== undefined) {
      document.getElementById('ta-badge').textContent =
        `TripAdvisor ${meta.taSuccess}/${meta.propertyCount}`;
    }

    // TripAdvisor key / data diagnostic
    if (status.tripadvisor === false) {
      const taBadge = document.getElementById('ta-badge');
      taBadge.textContent = 'TripAdvisor: key missing';
      taBadge.style.background = 'rgba(251,146,60,0.1)';
      taBadge.style.color = '#fb923c';
      taBadge.style.borderColor = 'rgba(251,146,60,0.3)';
    } else if (meta.taSuccess === 0) {
      const taBadge = document.getElementById('ta-badge');
      taBadge.textContent = 'TripAdvisor: no data ‚Äî click Refresh';
      taBadge.style.background = 'rgba(251,146,60,0.1)';
      taBadge.style.color = '#fb923c';
      taBadge.style.borderColor = 'rgba(251,146,60,0.3)';
    }

    if (!Array.isArray(data) || data.length === 0) {
      portfolio = [];
      renderSidebar();
      loadFolders();
      showWelcome();
      return;
    }

    portfolio = data;
    renderSidebar();
    loadFolders();
    showWelcome();

  } catch (err) {
    console.error('Failed to load data:', err);
    loadFolders();
    showWelcome();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Global Data Refresh
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function refreshAllData() {
  const btn = document.getElementById('header-refresh-btn');
  const lastFetchEl = document.getElementById('last-fetch');
  btn.disabled = true;
  btn.textContent = '‚Üª Starting‚Ä¶';
  try {
    const before = await fetch('/api/metadata').then(r => r.json()).catch(() => ({}));
    await fetch('/api/refresh', { method: 'POST' });
    // Re-enable immediately ‚Äî the fetch runs in background on the server
    btn.disabled = false;
    btn.textContent = '‚Üª Refresh Data';
    if (lastFetchEl) lastFetchEl.textContent = 'Refreshing data in background‚Ä¶';
    // Poll every 10 s (up to 10 min) until lastFetch changes, then auto-reload
    let polls = 0;
    const poll = setInterval(async () => {
      polls++;
      const after = await fetch('/api/metadata').then(r => r.json()).catch(() => ({}));
      if (after.lastFetch && after.lastFetch !== before.lastFetch) {
        clearInterval(poll);
        if (lastFetchEl) lastFetchEl.textContent = 'Refresh complete ‚Äî reloading‚Ä¶';
        setTimeout(() => location.reload(), 1000);
      } else if (polls >= 60) {
        clearInterval(poll);
        if (lastFetchEl) lastFetchEl.textContent = 'Refresh timed out ‚Äî reload manually';
      }
    }, 10000);
  } catch (err) {
    btn.disabled = false;
    btn.textContent = '‚Üª Refresh Data';
    alert('Refresh failed: ' + err.message);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Folders ‚Äî Load & Render
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFolders() {
  try {
    folders = await fetch('/api/folders').then(r => r.json());
    renderFolders();
  } catch (err) {
    console.error('Failed to load folders:', err);
  }
}

function renderFolders() {
  const container = document.getElementById('folders-list');
  if (!container) return;
  if (!folders.length) {
    container.innerHTML = '<div style="padding:8px 16px;font-size:11px;color:var(--text-muted);">No folders yet ‚Äî click Ôºã to create one</div>';
    return;
  }
  container.innerHTML = folders.map(f => {
    const isOpen = activeFolderStates[f.id] !== false;
    return `
      <div class="folder-group" id="folder-group-${escHtml(f.id)}">
        <div class="folder-header">
          <div class="folder-header-left" onclick="selectFolder('${escHtml(f.id)}')">
            <span class="folder-chevron ${isOpen ? 'open' : ''}" onclick="event.stopPropagation(); toggleFolder('${escHtml(f.id)}')">‚ñ∂</span>
            <span class="folder-name" title="${escHtml(f.name)}">${escHtml(f.name)}</span>
            <span class="folder-count">(${f.hotels.length})</span>
          </div>
          <button class="folder-delete-btn"
            onclick="event.stopPropagation(); deleteFolder('${escHtml(f.id)}', '${escHtml(f.name.replace(/'/g, "\\'"))}')"
            title="Delete folder">‚úï</button>
        </div>
        <div class="folder-hotel-list ${isOpen ? 'open' : ''}" id="folder-hotels-${escHtml(f.id)}">
          ${f.hotels.length === 0
            ? '<div style="padding:6px 10px;font-size:11px;color:var(--text-muted);">Empty folder</div>'
            : f.hotels.map(h => {
                const city = h.address?.split(',').slice(-3, -1).join(',').trim() || '';
                const isActive = selectedFolderHotel?.folderId === f.id && selectedFolderHotel?.placeId === h.placeId;
                return `
                  <div class="folder-hotel-item ${isActive ? 'active' : ''}"
                    onclick="selectSavedHotel('${escHtml(f.id)}', '${escHtml(h.placeId)}')">
                    <div class="folder-hotel-info">
                      <div class="folder-hotel-name" title="${escHtml(h.name)}">${escHtml(h.name)}</div>
                      <div class="folder-hotel-city">${escHtml(city)}</div>
                    </div>
                    ${h.rating ? `<span class="mini-rating google" style="flex-shrink:0;"><span class="star">‚òÖ</span><span class="val">${h.rating}</span></span>` : ''}
                    <button class="folder-hotel-remove"
                      onclick="event.stopPropagation(); removeFromFolder('${escHtml(f.id)}', '${escHtml(h.placeId)}', '${escHtml(h.name.replace(/'/g, "\\'"))}')"
                      title="Remove">‚úï</button>
                  </div>`;
              }).join('')
          }
        </div>
      </div>`;
  }).join('');
}

function toggleFolder(folderId) {
  activeFolderStates[folderId] = activeFolderStates[folderId] === false ? true : false;
  renderFolders();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Folders ‚Äî Create / Delete
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showNewFolderInput() {
  const row = document.getElementById('new-folder-row');
  row.classList.add('visible');
  const inp = document.getElementById('new-folder-name');
  inp.value = '';
  inp.focus();
}

document.getElementById('new-folder-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') createFolder();
  if (e.key === 'Escape') document.getElementById('new-folder-row').classList.remove('visible');
});

async function createFolder() {
  const name = document.getElementById('new-folder-name').value.trim();
  if (!name) return;
  try {
    const folder = await fetch('/api/folders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    }).then(r => r.json());
    if (folder.error) { alert(folder.error); return; }
    folders.push({ ...folder, hotels: [] });
    activeFolderStates[folder.id] = true;
    document.getElementById('new-folder-row').classList.remove('visible');
    renderFolders();
  } catch (err) {
    alert('Failed to create folder: ' + err.message);
  }
}

async function deleteFolder(folderId, folderName) {
  if (!confirm(`Delete folder "${folderName}" and all its saved hotels?`)) return;
  try {
    const r = await fetch(`/api/folders/${encodeURIComponent(folderId)}`, { method: 'DELETE' }).then(r => r.json());
    if (r.error) { alert(r.error); return; }
    folders = folders.filter(f => f.id !== folderId);
    if (selectedFolderHotel?.folderId === folderId) { selectedFolderHotel = null; showWelcome(); }
    renderFolders();
  } catch (err) {
    alert('Failed to delete folder: ' + err.message);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Save Dropdown
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSaveDropdown(hotel) {
  currentSearchHotel = hotel;
  const dropdown = document.getElementById('save-dropdown');
  if (!dropdown) return;
  const items = folders.map(f => {
    const alreadySaved = f.hotels.some(h => h.placeId === hotel.placeId);
    if (alreadySaved) return `<div class="save-dropdown-item already-saved">‚úì ${escHtml(f.name)}</div>`;
    return `<div class="save-dropdown-item" onclick="saveToFolder('${escHtml(f.id)}', '${escHtml(f.name.replace(/'/g, "\\'"))}')">${escHtml(f.name)}</div>`;
  }).join('');
  dropdown.innerHTML = items + `<div class="save-dropdown-item new-folder" onclick="saveDropdownNewFolder()">Ôºã New folder‚Ä¶</div>`;
  dropdown.classList.add('open');
  setTimeout(() => document.addEventListener('click', closeSaveDropdown, { once: true }), 0);
}

function closeSaveDropdown() {
  const dropdown = document.getElementById('save-dropdown');
  if (dropdown) dropdown.classList.remove('open');
}

async function saveToFolder(folderId, folderName) {
  closeSaveDropdown();
  if (!currentSearchHotel) return;
  const h = currentSearchHotel;
  const btn = document.getElementById('save-btn');
  if (btn) { btn.textContent = 'Saving‚Ä¶'; btn.disabled = true; }
  try {
    const result = await fetch(`/api/folders/${encodeURIComponent(folderId)}/hotels`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ placeId: h.placeId, name: h.name, address: h.address, rating: h.rating, totalRatings: h.totalRatings, taLocationId: h.tripadvisor?.locationId || null })
    }).then(r => r.json());
    if (result.error === 'Hotel already in folder') {
      if (btn) { btn.textContent = 'Save ‚ñæ'; btn.disabled = false; }
      alert(`Already saved in "${folderName}"`);
      return;
    }
    if (result.error) throw new Error(result.error);
    const folder = folders.find(f => f.id === folderId);
    if (folder) folder.hotels.push(result);
    renderFolders();
    if (btn) {
      btn.textContent = 'Saved ‚úì';
      btn.style.background = 'rgba(74,222,128,0.15)';
      btn.style.color = 'var(--google-green)';
      btn.style.borderColor = 'rgba(74,222,128,0.3)';
      setTimeout(() => {
        btn.textContent = 'Save ‚ñæ'; btn.style.background = ''; btn.style.color = ''; btn.style.borderColor = ''; btn.disabled = false;
      }, 1800);
    }
  } catch (err) {
    if (btn) { btn.textContent = 'Save ‚ñæ'; btn.disabled = false; }
    alert('Failed to save: ' + err.message);
  }
}

function saveDropdownNewFolder() {
  closeSaveDropdown();
  document.getElementById('folders-section').scrollIntoView({ behavior: 'smooth' });
  showNewFolderInput();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Saved Hotel ‚Äî View & Remove
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function selectSavedHotel(folderId, placeId) {
  selectedFolderHotel = { folderId, placeId };
  selectedId = null;
  selectedFolder = null;
  renderFolders();
  hideAllViews();
  document.getElementById('view-overview').style.display = 'block';
  document.getElementById('overview-content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const hotel = await fetch(`/api/folders/${encodeURIComponent(folderId)}/hotels/${encodeURIComponent(placeId)}`).then(r => r.json());
    if (hotel.error) throw new Error(hotel.error);
    renderSavedHotelOverview(hotel);
    if (!hotel.numRooms) fetchAndDisplayRooms(hotel.name, hotel.address, hotel.folderId, hotel.placeId, hotel.lat, hotel.lng);
    const _savedCached = hotel.cachedData?.reviewAnalysis || _reviewCache.get(hotel.placeId) || null;
    _reviewCtx = {
      name: hotel.name,
      googleReviews: hotel.cachedData?.reviews || [],
      taReviews: hotel.cachedData?.tripadvisor?.reviews || [],
      folderId: hotel.folderId,
      placeId: hotel.placeId
    };
    if (_savedCached) renderReviewAnalysis(_savedCached);
    else showReviewAnalysisButton();
  } catch (err) {
    document.getElementById('overview-content').innerHTML = `<div style="padding:32px;color:var(--red);">Failed to load: ${escHtml(err.message)}</div>`;
  }
}

function renderSavedHotelOverview(hotel) {
  const cached = hotel.cachedData || {};
  const ta = cached.tripadvisor || null;
  activeSearchReviewSource = 'all';
  currentSearchHotel = { reviews: cached.reviews || [], photos: cached.photos || [], tripadvisor: ta };
  const googlePhotos = cached.photos || [];
  const taPhotos = (ta?.photos || []).map(ph => ({
    url: ph.images?.large || ph.images?.medium || ph.images?.small || ph.images?.original,
    source: 'ta', caption: ph.caption,
  }));
  const allPhotos = [...googlePhotos, ...taPhotos];
  lightboxPhotos = allPhotos;
  const lastFetchedStr = hotel.lastFetched ? timeAgo(new Date(hotel.lastFetched)) : 'never';
  const taSubratingHtml = ta?.subratings
    ? Object.values(ta.subratings).map(s => `
        <div class="subrating-item">
          <span class="subrating-label">${escHtml(s.name)}</span>
          <span class="subrating-value">${s.value} <span style="color:var(--star);font-size:10px;">‚òÖ</span></span>
        </div>`).join('')
    : '';
  document.getElementById('overview-content').innerHTML = `
    <div class="property-header" style="margin-bottom:20px;">
      <div class="property-title-row">
        <div>
          <div style="margin-bottom:8px;"><span class="cached-badge">üìÅ ${escHtml(hotel.folderName)}</span></div>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <div class="property-title">${escHtml(hotel.name)}</div>
            ${hotel.numRooms
              ? `<span style="display:inline-flex;align-items:center;gap:4px;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);color:#a5b4fc;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:500;">üè® ${hotel.numRooms} rooms</span>`
              : `<span id="rooms-gem" style="display:inline-flex;align-items:center;gap:4px;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);color:#a5b4fc;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:500;">üè® <span id="rooms-gem-val" style="font-style:italic;opacity:0.7;">looking up‚Ä¶</span></span><span id="rooms-ta-id" style="font-size:10px;opacity:0.45;color:#a5b4fc;display:none;"></span>`}
          </div>
          <div class="property-location"><span>üìç</span><span>${escHtml(hotel.address || '')}</span></div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0;align-items:flex-start;">
          <button class="refresh-btn" id="saved-refresh-btn"
            onclick="refreshSavedHotel('${escHtml(hotel.folderId)}', '${escHtml(hotel.placeId)}')">
            ‚Üª Refresh
          </button>
          ${cached.googleMapsUrl ? `<a href="${cached.googleMapsUrl}" target="_blank" style="padding:7px 14px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);color:var(--google-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">Google Maps ‚Üó</a>` : ''}
          ${ta?.tripadvisorUrl ? `<a href="${ta.tripadvisorUrl}" target="_blank" style="padding:7px 14px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);color:var(--ta-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">TripAdvisor ‚Üó</a>` : ''}
        </div>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Last fetched: ${lastFetchedStr}</div>
      <div class="ratings-grid">
        <div class="rating-block">
          <div class="rating-source google">Google Reviews</div>
          <div class="rating-main"><span class="rating-number google">${hotel.rating || '‚Äî'}</span><span class="rating-max">/ 5</span></div>
          <div class="stars-row">${starsHtml(hotel.rating || 0)}</div>
          <div class="rating-count">${(hotel.totalRatings || 0).toLocaleString()} reviews</div>
        </div>
        ${ta ? `
        <div class="rating-block">
          <div class="rating-source ta">TripAdvisor</div>
          <div class="rating-main"><span class="rating-number ta">${ta.rating || '‚Äî'}</span><span class="rating-max">/ 5</span></div>
          <div class="stars-row">${starsHtml(ta.rating || 0)}</div>
          <div class="rating-count">${ta.numReviews || 0} reviews</div>
          ${taSubratingHtml ? `<div class="subratings">${taSubratingHtml}</div>` : ''}
          ${ta.rankingString ? `<div class="ranking-badge">${escHtml(ta.rankingString)}</div>` : ''}
        </div>` : ''}
      </div>
    </div>
    <div id="review-analysis" style="margin-bottom:16px;"></div>
    <div class="tabs" style="margin-bottom:20px;">
      <div class="tab active" id="tab-reviews" onclick="switchTab('reviews')">Reviews</div>
      <div class="tab" id="tab-photos" onclick="switchTab('photos')">Photos ${allPhotos.length > 0 ? `<span style="opacity:0.6;font-size:11px;">(${allPhotos.length})</span>` : ''}</div>
    </div>
    <div class="tab-content active" id="tab-content-reviews">
      ${renderSearchDualReviews(cached.reviews || [], ta?.reviews || [])}
    </div>
    <div class="tab-content" id="tab-content-photos">
      ${renderPhotos(allPhotos)}
    </div>`;
}

async function refreshSavedHotel(folderId, placeId) {
  const btn = document.getElementById('saved-refresh-btn');
  if (btn) { btn.classList.add('spinning'); btn.textContent = '‚Üª Refreshing‚Ä¶'; }
  try {
    const r = await fetch(`/api/folders/${encodeURIComponent(folderId)}/hotels/${encodeURIComponent(placeId)}/refresh`, { method: 'POST' }).then(r => r.json());
    if (r.error) throw new Error(r.error);
    await loadFolders();
    await selectSavedHotel(folderId, placeId);
  } catch (err) {
    if (btn) { btn.classList.remove('spinning'); btn.textContent = '‚Üª Refresh'; }
    alert('Refresh failed: ' + err.message);
  }
}

async function removeFromFolder(folderId, placeId, hotelName) {
  if (!confirm(`Remove "${hotelName}" from this folder?`)) return;
  try {
    const r = await fetch(`/api/folders/${encodeURIComponent(folderId)}/hotels/${encodeURIComponent(placeId)}`, { method: 'DELETE' }).then(r => r.json());
    if (r.error) { alert(r.error); return; }
    const folder = folders.find(f => f.id === folderId);
    if (folder) folder.hotels = folder.hotels.filter(h => h.placeId !== placeId);
    if (selectedFolderHotel?.folderId === folderId && selectedFolderHotel?.placeId === placeId) { selectedFolderHotel = null; showWelcome(); }
    renderFolders();
  } catch (err) {
    alert('Failed to remove: ' + err.message);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Folder Overview
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectFolder(folderId) {
  const folder = folders.find(f => f.id === folderId);
  if (!folder) return;
  selectedFolder = folderId;
  selectedId = null;
  selectedFolderHotel = null;
  activeFolderStates[folderId] = true;
  renderFolders();
  hideAllViews();
  document.getElementById('view-folder-overview').style.display = 'block';
  renderFolderOverview(folder);
}

function renderFolderOverview(folder) {
  const hotels = folder.hotels;
  const withScore = hotels.map(h => {
    const g  = h.rating       ? parseFloat(h.rating)     : null;
    const gN = h.totalRatings ? parseInt(h.totalRatings) : 0;
    const ta = h.taRating     ? parseFloat(h.taRating)   : null;
    const tN = h.taNumReviews ? parseInt(h.taNumReviews) : 0;
    let score = null;
    if (g !== null && ta !== null && (gN + tN) > 0) {
      score = (g * gN + ta * tN) / (gN + tN);
    } else {
      score = g ?? ta;
    }
    return { ...h, _score: score };
  }).filter(h => h._score != null);
  const top5 = [...withScore].sort((a, b) => b._score - a._score).slice(0, 5);
  const bot5 = [...withScore].sort((a, b) => a._score - b._score).slice(0, 5);
  const hasMap = hotels.some(h => h.lat && h.lng);

  const rankRow = (h, i, scoreColor) => `
    <div class="ranking-row" onclick="selectSavedHotel('${escHtml(folder.id)}','${escHtml(h.placeId)}')">
      <span class="ranking-pos">${i + 1}</span>
      <span class="ranking-name" title="${escHtml(h.name)}">${escHtml(h.name)}</span>
      <span class="ranking-score" style="color:${scoreColor};">‚òÖ ${h._score.toFixed(1)}</span>
    </div>`;

  document.getElementById('folder-overview-content').innerHTML = `
    <div class="folder-overview-header">
      <h2 style="font-family:'DM Serif Display',serif;font-size:22px;">${escHtml(folder.name)}</h2>
      <span style="font-size:13px;color:var(--text-muted);">${hotels.length} hotel${hotels.length !== 1 ? 's' : ''}</span>
    </div>
    ${hotels.length === 0
      ? `<div style="padding:48px;text-align:center;color:var(--text-muted);background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);">No hotels saved yet ‚Äî search for a hotel and save it to this folder.</div>`
      : `<div class="top-bottom-grid">
          <div class="ranking-card">
            <div class="ranking-card-title">‚¨Ü Top ${top5.length} by Avg Rating</div>
            ${top5.map((h, i) => rankRow(h, i, 'var(--google-green)')).join('')}
          </div>
          <div class="ranking-card">
            <div class="ranking-card-title">‚¨á Bottom ${bot5.length} by Avg Rating</div>
            ${bot5.map((h, i) => rankRow(h, i, 'var(--red)')).join('')}
          </div>
        </div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:11px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;color:var(--text-muted);">üìç Folder Map</div>
            ${hasMap ? `<button onclick="openMapFullscreen()" style="padding:3px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);border-radius:20px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;letter-spacing:0.03em;">‚§¢ Expand</button>` : ''}
          </div>
          ${hasMap
            ? `<div id="folder-map"></div>`
            : `<div style="padding:32px;text-align:center;color:var(--text-muted);font-size:13px;">No location data yet ‚Äî use ‚Üª Refresh on each hotel to add it to the map.</div>`}
        </div>`
    }`;

  if (hasMap) setTimeout(() => initFolderMap(hotels), 0);
}

function initFolderMap(hotels) {
  folderMapHotels = hotels;
  if (currentFolderMap) { currentFolderMap.remove(); currentFolderMap = null; }
  const mapEl = document.getElementById('folder-map');
  if (!mapEl) return;
  const withCoords = hotels.filter(h => h.lat && h.lng);
  if (!withCoords.length) return;

  currentFolderMap = L.map('folder-map');
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd', maxZoom: 19,
  }).addTo(currentFolderMap);

  const icon = L.divIcon({ className: 'folder-map-marker', iconSize: [12, 12], iconAnchor: [6, 6], popupAnchor: [0, -10] });

  withCoords.forEach(h => {
    const popup = `
      <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${escHtml(h.name)}</div>
      <div style="font-size:11px;color:#8891a8;margin-bottom:6px;">${escHtml(h.address || '')}</div>
      ${h.rating ? `<div style="color:#4ade80;font-weight:600;">‚òÖ ${h.rating} ¬∑ ${(h.totalRatings || 0).toLocaleString()} reviews</div>` : ''}`;
    L.marker([h.lat, h.lng], { icon }).bindPopup(popup, { maxWidth: 260 }).addTo(currentFolderMap);
  });

  const group = L.featureGroup(withCoords.map(h => L.marker([h.lat, h.lng])));
  currentFolderMap.fitBounds(group.getBounds().pad(0.3));
}

function timeAgo(date) {
  const s = Math.floor((Date.now() - date) / 1000);
  if (s < 60) return 'just now';
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Sidebar
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFilteredSorted() {
  const q = document.getElementById('search').value.toLowerCase();
  const sort = document.getElementById('sort-select').value;

  let items = [...portfolio];

  if (q) {
    items = items.filter(p =>
      p.name.toLowerCase().includes(q) ||
      p.city.toLowerCase().includes(q) ||
      p.brand.toLowerCase().includes(q) ||
      String(p.id).includes(q)
    );
  }

  items.sort((a, b) => {
    switch (sort) {
      case 'name': return a.name.localeCompare(b.name);
      case 'city': return a.city.localeCompare(b.city);
      case 'google-rating': {
        const ar = a.google?.rating || 0;
        const br = b.google?.rating || 0;
        return br - ar;
      }
      case 'ta-rating': {
        const ar = a.tripadvisor?.rating || 0;
        const br = b.tripadvisor?.rating || 0;
        return br - ar;
      }
      case 'google-reviews': {
        const ar = a.google?.totalRatings || 0;
        const br = b.google?.totalRatings || 0;
        return br - ar;
      }
      default: return a.id - b.id;
    }
  });

  return items;
}

function renderSidebar() {
  const items = getFilteredSorted();
  const list = document.getElementById('property-list');

  if (items.length === 0) {
    list.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:12px;text-align:center;">No properties match</div>';
    return;
  }

  list.innerHTML = items.map(p => {
    const gRating = p.google?.rating;
    const tRating = p.tripadvisor?.rating;
    const isActive = p.id === selectedId;

    return `
      <div class="property-item ${isActive ? 'active' : ''}" onclick="selectProperty(${p.id})">
        <div class="property-item-name">${p.id}. ${p.name}</div>
        <div class="property-item-meta">
          <span class="property-item-city">${p.city}, ${p.state}</span>
          ${gRating ? `<span class="mini-rating google"><span class="star">‚òÖ</span><span class="val">${gRating}</span></span>` : ''}
          ${tRating ? `<span class="mini-rating ta"><span class="star">‚òÖ</span><span class="val">${tRating}</span></span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

document.getElementById('search').addEventListener('input', onSearchInput);
document.getElementById('sort-select').addEventListener('change', renderSidebar);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Live Hotel Search
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let searchTimeout = null;

function onSearchInput() {
  const q = document.getElementById('search').value.trim();
  if (q.length === 0) {
    document.getElementById('sort-group').style.display = '';
    document.getElementById('list-label').textContent = 'Portfolio';
    renderSidebar();
    return;
  }
  document.getElementById('sort-group').style.display = 'none';
  document.getElementById('list-label').textContent = 'Search Results';
  if (q.length < 3) {
    document.getElementById('property-list').innerHTML =
      '<div style="padding:16px;color:var(--text-muted);font-size:12px;text-align:center;">Keep typing‚Ä¶</div>';
    return;
  }
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => doSearch(q), 400);
}

async function doSearch(q) {
  const list = document.getElementById('property-list');
  list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const results = await fetch(`/api/search?q=${encodeURIComponent(q)}`).then(r => r.json());
    if (results.error) {
      list.innerHTML = `<div style="padding:16px;color:var(--red);font-size:12px;">${escHtml(results.error)}</div>`;
      return;
    }
    if (!results.length) {
      list.innerHTML = '<div style="padding:16px;color:var(--text-muted);font-size:12px;text-align:center;">No hotels found</div>';
      return;
    }
    list.innerHTML = results.map(r => `
      <div class="property-item" data-place-id="${escHtml(r.placeId)}" data-hotel-name="${escHtml(r.name)}" onclick="selectSearchResult(this.dataset.placeId, this, this.dataset.hotelName)">
        <div class="property-item-name">${escHtml(r.name)}</div>
        <div class="property-item-meta">
          <span class="property-item-city">${escHtml(r.address?.split(',').slice(-3,-1).join(',').trim() || '')}</span>
          ${r.rating ? `<span class="mini-rating google"><span class="star">‚òÖ</span><span class="val">${r.rating}</span></span>` : ''}
        </div>
      </div>`).join('');
  } catch {
    list.innerHTML = '<div style="padding:16px;color:var(--red);font-size:12px;">Search failed</div>';
  }
}

async function selectSearchResult(placeId, el, name) {
  document.querySelectorAll('#property-list .property-item').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  selectedId = null;
  document.getElementById('view-welcome').style.display = 'none';
  document.getElementById('view-portfolio').style.display = 'none';
  document.getElementById('view-overview').style.display = 'block';
  document.getElementById('overview-content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const [hotel, taResults] = await Promise.all([
      fetch(`/api/hotel?placeId=${encodeURIComponent(placeId)}`).then(r => r.json()),
      name ? fetch(`/api/ta-search?q=${encodeURIComponent(name)}`).then(r => r.json()).catch(() => []) : Promise.resolve([]),
    ]);
    if (hotel.error) throw new Error(hotel.error);
    let taData = null;
    let taError = null;
    if (Array.isArray(taResults)) {
      if (taResults.length > 0) {
        const taDetail = await fetch(`/api/ta-hotel?locationId=${encodeURIComponent(taResults[0].locationId)}`).then(r => r.json()).catch(err => ({ error: err.message }));
        if (taDetail?.error) taError = taDetail.error;
        else taData = taDetail;
      }
      // length 0 means hotel simply not found on TA ‚Äî no error shown
    } else {
      taError = taResults?.error || 'TripAdvisor search failed';
    }
    renderSearchOverview(hotel, taData, taError);
    fetchAndDisplayRooms(hotel.name, hotel.address, null, null, hotel.lat, hotel.lng);
    const _searchCached = _reviewCache.get(hotel.place_id) || null;
    _reviewCtx = {
      name: hotel.name,
      googleReviews: hotel.reviews || [],
      taReviews: taData?.reviews || [],
      placeId: hotel.place_id
    };
    if (_searchCached) renderReviewAnalysis(_searchCached);
    else showReviewAnalysisButton();
  } catch (err) {
    document.getElementById('overview-content').innerHTML =
      `<div style="padding:32px;color:var(--red);">Failed to load: ${escHtml(err.message)}</div>`;
  }
}

function renderSearchOverview(hotel, taData, taError) {
  activeSearchReviewSource = 'all';
  currentSearchHotel = { ...hotel, tripadvisor: taData };
  const googlePhotos = hotel.photos || [];
  const taPhotos = (taData?.photos || []).map(ph => ({
    url: ph.images?.large || ph.images?.medium || ph.images?.small || ph.images?.original,
    source: 'ta', caption: ph.caption,
  }));
  const allPhotos = [...googlePhotos, ...taPhotos];
  lightboxPhotos = allPhotos;

  const taSubratingHtml = taData?.subratings
    ? Object.values(taData.subratings).map(s => `
        <div class="subrating-item">
          <span class="subrating-label">${escHtml(s.name)}</span>
          <span class="subrating-value">${s.value} <span style="color:var(--star);font-size:10px;">‚òÖ</span></span>
        </div>`).join('')
    : '';

  document.getElementById('overview-content').innerHTML = `
    <div class="property-header" style="margin-bottom:20px;">
      <div class="property-title-row">
        <div>
          <div style="margin-bottom:8px;"><span class="brand-tag">Search Result</span></div>
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <div class="property-title">${escHtml(hotel.name)}</div>
            <span id="rooms-gem" style="display:inline-flex;align-items:center;gap:4px;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);color:#a5b4fc;border-radius:20px;padding:3px 10px;font-size:12px;font-weight:500;">üè® <span id="rooms-gem-val" style="font-style:italic;opacity:0.7;">looking up‚Ä¶</span></span><span id="rooms-ta-id" style="font-size:10px;opacity:0.45;color:#a5b4fc;display:none;"></span>
          </div>
          <div class="property-location"><span>üìç</span><span>${escHtml(hotel.address || '')}</span></div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0;align-items:flex-start;">
          <div class="save-dropdown-wrap">
            <button class="save-btn" id="save-btn" onclick="openSaveDropdown(currentSearchHotel)">Save ‚ñæ</button>
            <div class="save-dropdown" id="save-dropdown"></div>
          </div>
          ${hotel.googleMapsUrl ? `<a href="${hotel.googleMapsUrl}" target="_blank" style="padding:7px 14px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);color:var(--google-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">Google Maps ‚Üó</a>` : ''}
          ${taData?.tripadvisorUrl ? `<a href="${taData.tripadvisorUrl}" target="_blank" style="padding:7px 14px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);color:var(--ta-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">TripAdvisor ‚Üó</a>` : ''}
        </div>
      </div>
      <div class="ratings-grid">
        <div class="rating-block">
          <div class="rating-source google">Google Reviews</div>
          <div class="rating-main">
            <span class="rating-number google">${hotel.rating || '‚Äî'}</span>
            <span class="rating-max">/ 5</span>
          </div>
          <div class="stars-row">${starsHtml(hotel.rating || 0)}</div>
          <div class="rating-count">${(hotel.totalRatings || 0).toLocaleString()} reviews</div>
        </div>
        ${taData ? `
        <div class="rating-block">
          <div class="rating-source ta">TripAdvisor</div>
          <div class="rating-main">
            <span class="rating-number ta">${taData.rating || '‚Äî'}</span>
            <span class="rating-max">/ 5</span>
          </div>
          <div class="stars-row">${starsHtml(taData.rating || 0)}</div>
          <div class="rating-count">${taData.numReviews || 0} reviews</div>
          ${taSubratingHtml ? `<div class="subratings">${taSubratingHtml}</div>` : ''}
          ${taData.rankingString ? `<div class="ranking-badge">${escHtml(taData.rankingString)}</div>` : ''}
        </div>` : taError ? `
        <div class="rating-block">
          <div class="rating-source ta">TripAdvisor</div>
          <div style="color:var(--red);font-size:11px;margin-top:8px;line-height:1.5;">‚ö† ${escHtml(taError)}</div>
        </div>` : ''}
      </div>
    </div>
    <div id="review-analysis" style="margin-bottom:16px;"></div>
    <div class="tabs" style="margin-bottom:20px;">
      <div class="tab active" id="tab-reviews" onclick="switchTab('reviews')">Reviews</div>
      <div class="tab" id="tab-photos" onclick="switchTab('photos')">
        Photos ${allPhotos.length > 0 ? `<span style="opacity:0.6;font-size:11px;">(${allPhotos.length})</span>` : ''}
      </div>
    </div>
    <div class="tab-content active" id="tab-content-reviews">
      ${renderSearchDualReviews(hotel.reviews || [], taData?.reviews || [])}
    </div>
    <div class="tab-content" id="tab-content-photos">
      ${renderPhotos(allPhotos)}
    </div>`;
}

function renderSearchDualReviews(googleReviews, taReviews) {
  const hasGoogle = googleReviews.length > 0;
  const hasTA = taReviews.length > 0;
  if (!hasGoogle && !hasTA) {
    return `<div class="no-data"><div class="no-data-icon">üí¨</div><div class="no-data-text">No reviews available</div></div>`;
  }
  const source = activeSearchReviewSource;
  const gCards = googleReviews.map(r => `
    <div class="review-card">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            ${r.profilePhoto ? `<img src="${r.profilePhoto}" onerror="this.parentNode.textContent='üë§'" alt="">` : 'üë§'}
          </div>
          <div>
            <div class="reviewer-name">${escHtml(r.author)}</div>
            <div class="review-rating-stars">
              ${Array.from({length:5},(_,i)=>`<span class="review-star ${i<r.rating?'':'empty'}">‚òÖ</span>`).join('')}
            </div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="review-date">${r.timeDescription || ''}</div>
          <div style="margin-top:3px;"><span class="badge badge-google" style="font-size:9px;padding:2px 6px;">Google</span></div>
        </div>
      </div>
      <div class="review-text">${truncateText(escHtml(r.text || ''), 280)}</div>
    </div>`).join('');
  const taCards = taReviews.map(r => `
    <div class="review-card">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">üë§</div>
          <div>
            <div class="reviewer-name">${escHtml(r.user?.username || 'Guest')}</div>
            ${r.user?.userLocation ? `<div class="reviewer-location">${escHtml(r.user.userLocation)}</div>` : ''}
            <div class="review-rating-stars">
              ${Array.from({length:5},(_,i)=>`<span class="review-star ${i<r.rating?'':'empty'}">‚òÖ</span>`).join('')}
            </div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="review-date">${r.publishedDate ? new Date(r.publishedDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''}</div>
          ${r.tripType ? `<div class="review-trip-type" style="margin-top:3px;">${r.tripType.replace('_',' ')}</div>` : ''}
          <div style="margin-top:3px;"><span class="badge badge-ta" style="font-size:9px;padding:2px 6px;">TripAdvisor</span></div>
        </div>
      </div>
      ${r.title ? `<div class="review-title" style="margin-bottom:6px;">${escHtml(r.title)}</div>` : ''}
      <div class="review-text">${truncateText(escHtml(r.text || ''), 280)}</div>
    </div>`).join('');
  return `
    <div class="reviews-header">
      <span style="font-size:13px;color:var(--text-muted);">${googleReviews.length + taReviews.length} reviews loaded</span>
      <div class="source-toggle">
        ${hasGoogle ? `<button class="source-btn google search-source-btn ${source==='google'?'active':''}" data-source="google" onclick="setSearchReviewSource('google')">Google (${googleReviews.length})</button>` : ''}
        ${hasTA ? `<button class="source-btn ta search-source-btn ${source==='ta'?'active':''}" data-source="ta" onclick="setSearchReviewSource('ta')">TripAdvisor (${taReviews.length})</button>` : ''}
        ${hasGoogle && hasTA ? `<button class="source-btn search-source-btn ${source==='all'?'active':''}" data-source="all" style="${source==='all'?'background:var(--surface2);color:var(--text-dim);border-color:var(--border-light);':''}" onclick="setSearchReviewSource('all')">All</button>` : ''}
      </div>
    </div>
    <div class="reviews-grid">
      ${source === 'google' ? gCards : source === 'ta' ? taCards : gCards + taCards}
    </div>`;
}

function setSearchReviewSource(source) {
  activeSearchReviewSource = source;
  const tabContent = document.getElementById('tab-content-reviews');
  if (tabContent && currentSearchHotel) {
    tabContent.innerHTML = renderSearchDualReviews(
      currentSearchHotel.reviews || [],
      currentSearchHotel.tripadvisor?.reviews || []
    );
  }
}

function renderSearchReviews(reviews) {
  if (!reviews.length) return `<div class="no-data"><div class="no-data-icon">üí¨</div><div class="no-data-text">No reviews available</div></div>`;
  return reviews.map(r => `
    <div class="review-card">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            ${r.profilePhoto ? `<img src="${r.profilePhoto}" onerror="this.parentNode.textContent='üë§'" alt="">` : 'üë§'}
          </div>
          <div>
            <div class="reviewer-name">${escHtml(r.author)}</div>
            <div class="review-rating-stars">
              ${Array.from({length:5},(_,i)=>`<span class="review-star ${i<r.rating?'':'empty'}">‚òÖ</span>`).join('')}
            </div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="review-date">${r.timeDescription || ''}</div>
          <div style="margin-top:3px;"><span class="badge badge-google" style="font-size:9px;padding:2px 6px;">Google</span></div>
        </div>
      </div>
      <div class="review-text">${escHtml(r.text || '')}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Views
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideAllViews() {
  document.getElementById('view-welcome').style.display = 'none';
  document.getElementById('view-overview').style.display = 'none';
  document.getElementById('view-portfolio').style.display = 'none';
  document.getElementById('view-folder-overview').style.display = 'none';
}

function showWelcome() {
  hideAllViews();
  document.getElementById('view-welcome').style.display = 'flex';
}

function showPortfolio() {
  selectedId = null;
  renderSidebar();
  hideAllViews();
  document.getElementById('view-portfolio').style.display = 'block';
  renderPortfolioTable();
}

function selectProperty(id) {
  selectedId = id;
  selectedFolder = null;
  selectedFolderHotel = null;
  renderSidebar();
  hideAllViews();
  document.getElementById('view-overview').style.display = 'block';
  renderPropertyOverview(id);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Property Overview
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function starsHtml(rating, max = 5) {
  const full = Math.round(rating);
  return Array.from({ length: max }, (_, i) =>
    `<span class="star-icon ${i < full ? '' : 'empty'}">‚òÖ</span>`
  ).join('');
}

function renderPropertyOverview(id) {
  const p = portfolio.find(x => x.id === id);
  if (!p) return;

  const g = p.google;
  const ta = p.tripadvisor;

  // All photos: Google first, then TripAdvisor
  const googlePhotos = (g?.photos || []).map(ph => ({ ...ph, source: 'google' }));
  const taPhotos = (ta?.photos || []).map(ph => ({
    url: ph.images?.large || ph.images?.medium || ph.images?.small || ph.images?.original,
    source: 'ta',
    caption: ph.caption,
  }));
  const allPhotos = [...googlePhotos, ...taPhotos];

  const hasData = g || ta;

  const subratingHtml = ta?.subratings
    ? Object.values(ta.subratings).map(s => `
        <div class="subrating-item">
          <span class="subrating-label">${s.name}</span>
          <span class="subrating-value">${s.value} <span style="color:var(--star);font-size:10px;">‚òÖ</span></span>
        </div>
      `).join('')
    : '';

  document.getElementById('overview-content').innerHTML = `

    <!-- Property Header -->
    <div class="property-header" style="margin-bottom:20px;">
      <div class="property-title-row">
        <div>
          <div style="margin-bottom:8px;">
            <span class="brand-tag">${p.brand}</span>
            <span style="margin-left:6px;font-size:12px;color:var(--text-muted);">#${p.id}</span>
          </div>
          <div class="property-title">${p.name}</div>
          <div class="property-location">
            <span>üìç</span>
            <span>${p.address || `${p.city}, ${p.state}`}</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0;">
          ${g?.googleMapsUrl ? `<a href="${g.googleMapsUrl}" target="_blank" style="padding:7px 14px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);color:var(--google-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">Google Maps ‚Üó</a>` : ''}
          ${ta?.tripadvisorUrl ? `<a href="${ta.tripadvisorUrl}" target="_blank" style="padding:7px 14px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);color:var(--ta-green);border-radius:var(--radius-sm);font-size:12px;font-weight:600;text-decoration:none;">TripAdvisor ‚Üó</a>` : ''}
        </div>
      </div>

      ${hasData ? `
        <div class="ratings-grid">
          <!-- Google -->
          <div class="rating-block">
            <div class="rating-source google">Google Reviews</div>
            ${g && !g.error ? `
              <div class="rating-main">
                <span class="rating-number google">${g.rating || '‚Äî'}</span>
                <span class="rating-max">/ 5</span>
              </div>
              <div class="stars-row">${starsHtml(g.rating || 0)}</div>
              <div class="rating-count">${(g.totalRatings || 0).toLocaleString()} reviews</div>
            ` : `<div style="color:var(--text-muted);font-size:12px;margin-top:8px;">${g?.error || 'Not fetched'}</div>`}
          </div>

          <!-- TripAdvisor -->
          <div class="rating-block">
            <div class="rating-source ta">TripAdvisor</div>
            ${ta && !ta.error ? `
              <div class="rating-main">
                <span class="rating-number ta">${ta.rating || '‚Äî'}</span>
                <span class="rating-max">/ 5</span>
              </div>
              <div class="stars-row">${starsHtml(ta.rating || 0)}</div>
              <div class="rating-count">${(ta.numReviews || 0).toLocaleString()} reviews</div>
              ${subratingHtml ? `<div class="subratings">${subratingHtml}</div>` : ''}
              ${ta.rankingString ? `<div class="ranking-badge">${ta.rankingString}</div>` : ''}
            ` : `<div style="color:var(--text-muted);font-size:12px;margin-top:8px;">${ta?.error || 'Not fetched'}</div>`}
          </div>
        </div>
      ` : `
        <div style="margin-top:16px;padding:16px;background:var(--surface2);border-radius:var(--radius-sm);color:var(--text-muted);font-size:13px;">
          No data available. Run <code style="background:var(--bg);padding:1px 5px;border-radius:4px;">npm run fetch</code> to load data.
        </div>
      `}
    </div>

    <!-- Tabs -->
    <div class="tabs" style="margin-bottom:20px;">
      <div class="tab active" id="tab-reviews" onclick="switchTab('reviews')">Reviews</div>
      <div class="tab" id="tab-photos" onclick="switchTab('photos')">
        Photos ${allPhotos.length > 0 ? `<span style="opacity:0.6;font-size:11px;">(${allPhotos.length})</span>` : ''}
      </div>
    </div>

    <!-- Reviews Tab -->
    <div class="tab-content active" id="tab-content-reviews">
      ${renderReviews(p)}
    </div>

    <!-- Photos Tab -->
    <div class="tab-content" id="tab-content-photos">
      ${renderPhotos(allPhotos)}
    </div>

  `;

  // Store photos for lightbox
  lightboxPhotos = allPhotos;
}

function renderReviews(p) {
  const g = p.google;
  const ta = p.tripadvisor;

  const hasGoogle = g && !g.error && g.reviews?.length > 0;
  const hasTA = ta && !ta.error && ta.reviews?.length > 0;

  if (!hasGoogle && !hasTA) {
    return `<div class="no-data">
      <div class="no-data-icon">üí¨</div>
      <div class="no-data-text">No reviews loaded yet</div>
      <div class="no-data-hint">Run <code>npm run fetch</code> to pull review data</div>
    </div>`;
  }

  const googleReviewsHtml = hasGoogle ? g.reviews.map(r => `
    <div class="review-card">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            ${r.profilePhoto ? `<img src="${r.profilePhoto}" onerror="this.parentNode.textContent='üë§'" alt="">` : 'üë§'}
          </div>
          <div>
            <div class="reviewer-name">${escHtml(r.author)}</div>
            <div class="review-rating-stars">
              ${Array.from({length:5},(_,i)=>`<span class="review-star ${i<r.rating?'':'empty'}">‚òÖ</span>`).join('')}
            </div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="review-date">${r.timeDescription || ''}</div>
          <div style="margin-top:3px;"><span class="badge badge-google" style="font-size:9px;padding:2px 6px;">Google</span></div>
        </div>
      </div>
      <div class="review-text" id="review-g-${r.time}">
        ${truncateText(escHtml(r.text || ''), 280)}
      </div>
    </div>
  `).join('') : '';

  const taReviewsHtml = hasTA ? ta.reviews.map(r => `
    <div class="review-card">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            ${r.user?.avatar ? `<img src="${r.user.avatar}" onerror="this.parentNode.textContent='üë§'" alt="">` : 'üë§'}
          </div>
          <div>
            <div class="reviewer-name">${escHtml(r.user?.username || 'Guest')}</div>
            ${r.user?.userLocation ? `<div class="reviewer-location">${escHtml(r.user.userLocation)}</div>` : ''}
            <div class="review-rating-stars">
              ${Array.from({length:5},(_,i)=>`<span class="review-star ${i<r.rating?'':'empty'}">‚òÖ</span>`).join('')}
            </div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="review-date">${r.publishedDate ? new Date(r.publishedDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : ''}</div>
          ${r.tripType ? `<div class="review-trip-type" style="margin-top:3px;">${r.tripType.replace('_',' ')}</div>` : ''}
          <div style="margin-top:3px;"><span class="badge badge-ta" style="font-size:9px;padding:2px 6px;">TripAdvisor</span></div>
        </div>
      </div>
      ${r.title ? `<div class="review-title" style="margin-bottom:6px;">${escHtml(r.title)}</div>` : ''}
      <div class="review-text">
        ${truncateText(escHtml(r.text || ''), 280)}
      </div>
    </div>
  `).join('') : '';

  // Show both sources side by side with toggle
  const activeSource = activeReviewSource;

  return `
    <div class="reviews-header">
      <span style="font-size:13px;color:var(--text-muted);">
        ${(g?.reviews?.length || 0) + (ta?.reviews?.length || 0)} reviews loaded
      </span>
      <div class="source-toggle">
        ${hasGoogle ? `<button class="source-btn google ${activeSource==='google'?'active':''}" onclick="setReviewSource('google', ${p.id})">Google (${g.reviews.length})</button>` : ''}
        ${hasTA ? `<button class="source-btn ta ${activeSource==='ta'?'active':''}" onclick="setReviewSource('ta', ${p.id})">TripAdvisor (${ta.reviews.length})</button>` : ''}
        ${hasGoogle && hasTA ? `<button class="source-btn ${activeSource==='all'?'active':''}" style="${activeSource==='all'?'background:var(--surface2);color:var(--text-dim);border-color:var(--border-light);':''}" onclick="setReviewSource('all', ${p.id})">All</button>` : ''}
      </div>
    </div>
    <div class="reviews-grid" id="reviews-container">
      ${activeSource === 'google' ? googleReviewsHtml :
        activeSource === 'ta' ? taReviewsHtml :
        googleReviewsHtml + taReviewsHtml}
    </div>
  `;
}

function setReviewSource(source, id) {
  activeReviewSource = source;
  renderPropertyOverview(id);
  // Re-activate reviews tab
  setTimeout(() => switchTab('reviews'), 10);
}

function renderPhotos(photos) {
  if (photos.length === 0) {
    return `<div class="no-data">
      <div class="no-data-icon">üì∑</div>
      <div class="no-data-text">No photos loaded yet</div>
      <div class="no-data-hint">Run <code>npm run fetch</code> to pull photo data</div>
    </div>`;
  }

  return `
    <div class="photos-grid">
      ${photos.map((ph, idx) => {
        const url = ph.url;
        if (!url) return '';
        return `
          <div class="photo-card" onclick="openLightbox(${idx})">
            <img src="${url}" alt="${escHtml(ph.caption || '')}" loading="lazy"
              onerror="this.parentNode.style.display='none'">
            <span class="photo-source-tag ${ph.source}">${ph.source === 'google' ? 'G' : 'TA'}</span>
            ${ph.caption ? `<div class="photo-caption">${escHtml(ph.caption)}</div>` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  document.getElementById(`tab-content-${tab}`).classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Portfolio Table
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPortfolioTable() {
  const wrap = document.getElementById('portfolio-table-wrap');
  const items = [...portfolio].sort((a,b) => a.id - b.id);

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Property</th>
          <th>Brand</th>
          <th>City</th>
          <th>Google Rating</th>
          <th>Google Reviews</th>
          <th>TA Rating</th>
          <th>TA Reviews</th>
          <th>TA Ranking</th>
        </tr>
      </thead>
      <tbody>
        ${items.map(p => {
          const g = p.google;
          const ta = p.tripadvisor;
          return `
            <tr onclick="selectProperty(${p.id})">
              <td style="color:var(--text-muted);font-size:12px;">${p.id}</td>
              <td><div class="table-name">${p.name}</div></td>
              <td class="table-brand">${p.brand}</td>
              <td class="table-city">${p.city}, ${p.state}</td>
              <td>
                ${g && !g.error && g.rating
                  ? `<span class="rating-pill google">‚òÖ ${g.rating}</span>`
                  : `<span class="rating-pill none">‚Äî</span>`}
              </td>
              <td style="color:var(--text-muted);">
                ${g && !g.error && g.totalRatings ? (g.totalRatings).toLocaleString() : '‚Äî'}
              </td>
              <td>
                ${ta && !ta.error && ta.rating
                  ? `<span class="rating-pill ta">‚òÖ ${ta.rating}</span>`
                  : `<span class="rating-pill none">‚Äî</span>`}
              </td>
              <td style="color:var(--text-muted);">
                ${ta && !ta.error && ta.numReviews ? (ta.numReviews).toLocaleString() : '‚Äî'}
              </td>
              <td style="font-size:11px;color:var(--text-muted);">
                ${ta && !ta.error && ta.rankingString ? ta.rankingString.replace(/^#\d+ of /, '#').slice(0,35) + '...' : '‚Äî'}
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Export CSV
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const headers = ['ID','Name','Brand','City','State','Google Rating','Google Reviews','TA Rating','TA Reviews','TA Ranking','Google URL','TA URL'];
  const rows = portfolio.map(p => [
    p.id,
    `"${p.name}"`,
    `"${p.brand}"`,
    p.city,
    p.state,
    p.google?.rating || '',
    p.google?.totalRatings || '',
    p.tripadvisor?.rating || '',
    p.tripadvisor?.numReviews || '',
    `"${p.tripadvisor?.rankingString || ''}"`,
    p.google?.googleMapsUrl || '',
    p.tripadvisor?.tripadvisorUrl || '',
  ]);

  const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `portfolio-intel-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Lightbox
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openLightbox(idx) {
  lightboxIdx = idx;
  updateLightboxImg();
  document.getElementById('lightbox').classList.add('open');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
}

function lightboxNav(dir) {
  lightboxIdx = (lightboxIdx + dir + lightboxPhotos.length) % lightboxPhotos.length;
  updateLightboxImg();
}

function updateLightboxImg() {
  const ph = lightboxPhotos[lightboxIdx];
  document.getElementById('lightbox-img').src = ph?.url || '';
}

document.getElementById('lightbox').addEventListener('click', function(e) {
  if (e.target === this) closeLightbox();
});

document.addEventListener('keydown', e => {
  if (document.getElementById('lightbox').classList.contains('open')) {
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') lightboxNav(-1);
    if (e.key === 'ArrowRight') lightboxNav(1);
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Claude Room Count
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchAndDisplayRooms(name, address, folderId, placeId, lat, lng) {
  try {
    const params = { name: name || '', address: address || '' };
    if (lat != null) params.lat = lat;
    if (lng != null) params.lng = lng;
    const r = await fetch(`/api/rooms-lookup?${new URLSearchParams(params)}`);
    if (!r.ok) return;
    const { numRooms, taLocationId } = await r.json();
    const el = document.getElementById('rooms-gem-val');
    if (!el) return; // user navigated away
    // Show TA location ID in small muted text so it can be verified
    const taEl = document.getElementById('rooms-ta-id');
    if (taEl && taLocationId) {
      taEl.textContent = `TA: ${taLocationId}`;
      taEl.style.display = 'inline';
    }
    if (numRooms) {
      el.textContent = `${numRooms} rooms`;
      el.style.fontStyle = 'normal';
      el.style.opacity = '1';
      if (folderId && placeId) {
        fetch(`/api/folders/${encodeURIComponent(folderId)}/hotels/${encodeURIComponent(placeId)}/rooms`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ numRooms })
        }).catch(() => {});
      }
    } else {
      el.textContent = 'rooms: ?';
      el.style.fontStyle = 'normal';
      el.style.opacity = '0.45';
    }
    // Update photos with the geo-anchored TA location so images match the correct hotel.
    // The initial TA search uses name-only text matching and may have resolved a different
    // property (e.g. wrong Moxy). rooms-lookup is now the authoritative source.
    if (taLocationId) {
      try {
        const taFresh = await fetch(`/api/ta-hotel?locationId=${encodeURIComponent(taLocationId)}`).then(r => r.ok ? r.json() : null);
        if (taFresh && !taFresh.error) {
          const freshTaPhotos = (taFresh.photos || []).map(ph => ({
            url: ph.images?.large || ph.images?.medium || ph.images?.small || ph.images?.original,
            source: 'ta', caption: ph.caption,
          }));
          // Replace any TA photos already shown with the geo-correct set (keep Google photos)
          lightboxPhotos = [...lightboxPhotos.filter(p => p.source !== 'ta'), ...freshTaPhotos];
          const photoContent = document.getElementById('tab-content-photos');
          if (photoContent) photoContent.innerHTML = renderPhotos(lightboxPhotos);
          const photoTab = document.getElementById('tab-photos');
          if (photoTab) photoTab.innerHTML = `Photos${lightboxPhotos.length > 0 ? ` <span style="opacity:0.6;font-size:11px;">(${lightboxPhotos.length})</span>` : ''}`;
        }
      } catch { /* fail silently ‚Äî photos already displaying */ }
    }
  } catch {
    const el2 = document.getElementById('rooms-gem-val');
    if (el2) { el2.textContent = 'rooms: ?'; el2.style.opacity = '0.45'; }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Claude Review Sentiment Analysis
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showReviewAnalysisButton() {
  const el = document.getElementById('review-analysis');
  if (!el) return;
  if (!_reviewCtx?.googleReviews?.length && !_reviewCtx?.taReviews?.length) { el.remove(); return; }
  el.innerHTML = `<button onclick="triggerReviewAnalysis()"
    style="background:var(--surface);border:1px solid var(--border);border-radius:8px;
           padding:9px 16px;font-size:12px;color:var(--text-muted);cursor:pointer;
           width:100%;text-align:left;transition:border-color 0.15s;">
    ‚ú® Analyze Reviews with AI
  </button>`;
}

async function triggerReviewAnalysis() {
  if (!_reviewCtx) return;
  const el = document.getElementById('review-analysis');
  if (el) el.innerHTML = `<div style="font-size:12px;font-style:italic;color:var(--text-muted);padding:6px 0;">‚ú® Analyzing reviews‚Ä¶</div>`;
  try {
    const body = {
      name: _reviewCtx.name,
      googleReviews: _reviewCtx.googleReviews,
      taReviews: _reviewCtx.taReviews,
      ...(_reviewCtx.folderId && _reviewCtx.placeId ? { folderId: _reviewCtx.folderId, placeId: _reviewCtx.placeId } : {})
    };
    const r = await fetch('/api/review-analysis', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) { if (el) el.remove(); return; }
    const result = await r.json();
    if (!result.summary) { if (el) el.remove(); return; }
    if (_reviewCtx.placeId) _reviewCache.set(_reviewCtx.placeId, result);
    renderReviewAnalysis(result);
  } catch {
    if (el) el.remove();
  }
}

function renderReviewAnalysis({ summary, top3best = [], top3worst = [] }) {
  const el = document.getElementById('review-analysis');
  if (!el) return;
  const quoteCard = (q, positive) =>
    `<div style="background:var(--surface);border:1px solid var(--border);border-left:3px solid ${positive ? 'var(--green)' : 'var(--red)'};border-radius:8px;padding:10px 12px;margin-bottom:8px;">
      <div style="font-size:12px;line-height:1.6;color:var(--text);">"${escHtml(q.quote)}"</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:5px;">${starsHtml(q.rating)}&nbsp;${escHtml(q.author)} ¬∑ <span style="opacity:0.7;">${escHtml(q.source)}</span></div>
    </div>`;
  el.innerHTML =
    `<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:4px;">
      <div style="font-size:11px;font-weight:600;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:10px;">‚ú® AI Review Analysis</div>
      <p style="font-size:13px;line-height:1.65;color:var(--text);margin:0 0 16px;">${escHtml(summary)}</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--green);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">üåü Top Highlights</div>
          ${top3best.map(q => quoteCard(q, true)).join('')}
        </div>
        <div>
          <div style="font-size:11px;font-weight:600;color:var(--red);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">‚ö†Ô∏è Top Concerns</div>
          ${top3worst.map(q => quoteCard(q, false)).join('')}
        </div>
      </div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Helpers
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function truncateText(text, maxLen) {
  if (!text || text.length <= maxLen) return text;
  return text.slice(0, maxLen) + `<span class="read-more" onclick="this.parentNode.innerHTML=\`${text.replace(/`/g,'\\`').replace(/\$/g,'\\$')}\`">... read more</span>`;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  Boot
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>

<!-- Fullscreen Map Modal -->
<div id="map-fullscreen-modal">
  <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface);">
    <span style="font-size:13px;font-weight:600;letter-spacing:0.04em;color:var(--text);">üìç Folder Map</span>
    <button onclick="closeMapFullscreen()" style="padding:5px 14px;background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);border-radius:20px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;">‚úï Close</button>
  </div>
  <div id="map-fullscreen-map"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Fullscreen Map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openMapFullscreen() {
  const modal = document.getElementById('map-fullscreen-modal');
  modal.classList.add('open');
  if (currentFullscreenMap) { currentFullscreenMap.remove(); currentFullscreenMap = null; }
  const mapEl = document.getElementById('map-fullscreen-map');
  if (!mapEl) return;
  const withCoords = folderMapHotels.filter(h => h.lat && h.lng);
  if (!withCoords.length) return;

  currentFullscreenMap = L.map('map-fullscreen-map');
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd', maxZoom: 19,
  }).addTo(currentFullscreenMap);

  const icon = L.divIcon({ className: 'folder-map-marker', iconSize: [14, 14], iconAnchor: [7, 7], popupAnchor: [0, -10] });
  withCoords.forEach(h => {
    const popup = `
      <div style="font-size:13px;font-weight:600;margin-bottom:4px;">${escHtml(h.name)}</div>
      <div style="font-size:11px;color:#8891a8;margin-bottom:6px;">${escHtml(h.address || '')}</div>
      ${h.rating ? `<div style="color:#4ade80;font-weight:600;">‚òÖ ${h.rating} ¬∑ ${(h.totalRatings || 0).toLocaleString()} reviews</div>` : ''}`;
    L.marker([h.lat, h.lng], { icon }).bindPopup(popup, { maxWidth: 300 }).addTo(currentFullscreenMap);
  });
  const group = L.featureGroup(withCoords.map(h => L.marker([h.lat, h.lng])));
  currentFullscreenMap.fitBounds(group.getBounds().pad(0.2));
}

function closeMapFullscreen() {
  document.getElementById('map-fullscreen-modal').classList.remove('open');
  if (currentFullscreenMap) { currentFullscreenMap.remove(); currentFullscreenMap = null; }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeMapFullscreen();
});
</script>

</body>
</html>
